<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindBlast | Account</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600&family=IBM+Plex+Sans&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="icon" href="/images/favicon.png" type="image/png">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root {
      --primary-purple: #7E3FF2;
      --dark-purple: #2E0B40;
      --light-purple: #9a5dff;
      --background-dark: #191919;
      --text-light: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.7);
      --border-color: rgba(255, 255, 255, 0.15);
      --card-shadow: 0 8px 24px rgba(0,0,0,0.6);
      --rounded-xl: 25px;
      --rounded-lg: 15px;
      --transition-ease: all 0.3s ease;
      --warning-yellow: #ffc107;
      --error-red: #f44336;
      --success-green: #4CAF50;

      /* New Achievement specific colors */
      --achievement-bg-locked: rgba(0, 0, 0, 0.1);
      --achievement-border-locked: rgba(255, 255, 255, 0.05);
      --achievement-text-locked: rgba(255, 255, 255, 0.3);
      --achievement-icon-locked: rgba(255, 255, 255, 0.2);

      --achievement-bg-unlocked: rgba(126, 63, 242, 0.2); /* Semi-transparent primary purple */
      --achievement-border-unlocked: var(--primary-purple);
      --achievement-text-unlocked: var(--text-light);
      --achievement-icon-unlocked: var(--primary-purple);
      --achievement-glow: 0 0 10px var(--primary-purple), 0 0 20px var(--light-purple);
    }

    /* Overall Layout */
    .account-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: var(--text-light);
      font-family: 'IBM Plex Sans', sans-serif;
      background-color: var(--background-dark);
      min-height: 100vh;
      box-sizing: border-box; /* Ensure padding is included in height */
    }

    /* Account Card */
    .account-card {
      background: var(--dark-purple);
      padding: 2.5rem; /* Increased padding */
      border-radius: var(--rounded-xl); /* More rounded */
      box-shadow: var(--card-shadow);
      width: 100%;
      max-width: 550px; /* Slightly wider */
      animation: fadeInUp 0.8s ease forwards; /* Slower animation */
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.08); /* Subtle border */
    }

    /* Back Button */
    .back-button {
      position: absolute;
      top: 1.5rem;
      left: 1.5rem;
      color: var(--text-light);
      background: none;
      border: none;
      font-size: 2rem; /* Larger icon */
      cursor: pointer;
      border-radius: 50%; /* Perfectly round */
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .back-button:hover {
      background-color: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
    }

    /* Account Heading */
    .account-card h2 {
      font-family: 'Fredoka', sans-serif;
      font-size: 2.5rem; /* Larger heading */
      margin-bottom: 2rem; /* More space below */
      text-align: center;
      color: var(--text-light);
      text-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Subtle text shadow */
    }

    /* Avatar and Level Container */
    .avatar-container {
        position: relative;
        width: 120px; /* Larger avatar */
        height: 120px;
        margin: 0 auto 2rem auto; /* More space below avatar */
    }

    .account-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 4px solid var(--primary-purple); /* Thicker, primary color border */
        background-color: var(--dark-purple); /* Keep avatar background dark */
        color: var(--text-light);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 50px; /* Larger initial */
        font-weight: bold;
        user-select: none;
        box-shadow: 0 0 0 8px rgba(126, 63, 242, 0.2); /* Glow effect */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .account-avatar:hover {
        transform: scale(1.03);
        box-shadow: 0 0 0 10px rgba(126, 63, 242, 0.3);
    }

    /* Level Indicator */
    .level-indicator {
        position: absolute;
        bottom: 5px; /* Position closer to the bottom right */
        right: 5px;
        background-color: var(--warning-yellow); /* Yellow for emphasis */
        color: #333; /* Dark text for contrast */
        border-radius: 50%;
        width: 40px; /* Size of the level circle */
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
        border: 2px solid var(--text-light); /* White border around the circle */
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        z-index: 10; /* Ensure it's above the avatar */
    }

    /* Account Details & Activity Summary */
    .account-details, .activity-summary {
      background-color: rgba(0, 0, 0, 0.2); /* Slightly transparent background */
      border-radius: var(--rounded-lg);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); /* Inner shadow for depth */
    }

    .account-details p, .activity-summary p {
      font-size: 1.05rem; /* Slightly larger text */
      padding: 0.8rem 0; /* Increased padding */
      border-bottom: 1px dashed var(--border-color); /* Dashed line for softer look */
      display: flex;
      align-items: center;
      gap: 12px; /* More space between text and icon */
      color: var(--text-muted); /* Muted text color */
    }
    .account-details p:last-child, .activity-summary p:last-child {
      border-bottom: none; /* No border for the last item */
    }

    .account-details p strong {
        flex-shrink: 0;
        color: var(--text-light); /* Emphasize labels */
    }

    .account-details p span[contenteditable="true"] {
      background-color: var(--text-light);
      color: var(--background-dark);
      border-radius: var(--rounded-sm);
      padding: 0.4rem 0.7rem;
      width: 100%;
      outline: none;
      flex-grow: 1;
      transition: background-color 0.3s ease, border 0.3s ease;
      border: 2px solid transparent; /* Default transparent border */
    }
    .account-details p span[contenteditable="true"]:focus {
        border: 2px solid var(--primary-purple); /* Highlight on focus */
    }
    .account-details p span[contenteditable="false"] {
        flex-grow: 1;
        color: var(--text-light); /* Actual values are bright */
    }

    /* Input Fields (for password section) */
    .password-section input[type="password"],
    .reauth-modal input[type="email"],
    .reauth-modal input[type="password"] {
      background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent white */
      color: var(--background-dark);
      border-radius: var(--rounded-lg);
      padding: 0.8rem;
      width: 100%; /* Adjust for padding */
      box-sizing: border-box; 
      border: none;
      margin-bottom: 1.2rem;
      font-size: 1rem;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
      transition: box-shadow 0.3s ease;
    }
    .password-section input[type="password"]:focus,
    .reauth-modal input[type="email"]:focus,
    .reauth-modal input[type="password"]:focus {
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2), 0 0 0 3px rgba(126, 63, 242, 0.3); /* Focus glow */
    }

    /* Action Buttons */
    .account-actions {
      display: flex;
      justify-content: space-between;
      gap: 1.5rem; /* Increased gap */
      margin-top: 2.5rem; /* More space above buttons */
      flex-wrap: wrap;
    }

    .btn-primary {
      flex: 1;
      padding: 1rem 1.5rem; /* More padding */
      background-color: var(--primary-purple);
      border: none;
      color: var(--text-light);
      font-weight: bold;
      border-radius: var(--rounded-lg); /* Consistent rounding */
      cursor: pointer;
      transition: var(--transition-ease);
      font-size: 1.1rem; /* Slightly larger text */
      text-transform: uppercase; /* Uppercase text */
      letter-spacing: 0.5px;
    }

    .btn-primary:hover:not(:disabled) {
      background-color: var(--light-purple);
      transform: translateY(-2px); /* Slight lift effect */
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    .btn-primary:disabled {
      background-color: #5e2b76;
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
      transform: none;
    }

    /* Modals - General */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8); /* Darker overlay */
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px); /* Blurred background */
    }

    .modal-content {
      background-color: var(--dark-purple); /* Dark purple background */
      padding: 30px; /* More padding */
      border-radius: var(--rounded-xl);
      box-shadow: var(--card-shadow);
      width: 100%;
      max-width: 450px; /* Slightly larger modal */
      text-align: center;
      position: relative;
      animation: fadeInScale 0.4s ease-out; /* New animation */
      color: var(--text-light);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Modal Specifics */
    .small-modal {
      max-width: 400px;
    }
    .modal-content h2 {
        color: var(--text-light);
        margin-bottom: 1.2rem;
        font-size: 2rem; /* Larger modal title */
    }
    .modal-content p {
        margin-bottom: 1.8rem;
        line-height: 1.6;
        color: var(--text-muted);
        font-size: 1.05rem;
    }
    .modal-actions {
        display: flex;
        justify-content: space-around;
        gap: 1rem;
    }
    .modal-actions .btn {
        flex-grow: 1;
        padding: 0.9rem; /* More padding for modal buttons */
        border-radius: var(--rounded-lg);
        font-size: 1rem;
        font-weight: bold;
        transition: var(--transition-ease);
    }

    .red-btn {
      background-color: var(--error-red);
      color: var(--text-light);
    }
    .red-btn:hover:not(:disabled) {
      background-color: #d32f2f;
      transform: translateY(-2px);
    }

    .green-btn {
      background-color: var(--success-green);
      color: var(--text-light);
    }
    .green-btn:hover:not(:disabled) {
      background-color: #388e3c;
      transform: translateY(-2px);
    }

    .red-btn:disabled, .green-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .countdown-timer {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--error-red);
      margin-bottom: 1.5rem;
    }

    /* Keyframe Animations */
    @keyframes fadeInUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @media (max-width: 600px) {
      .account-card {
        padding: 1.5rem;
      }
      .account-card h2 {
          font-size: 2rem;
      }
      .back-button {
          top: 1rem;
          left: 1rem;
          font-size: 1.5rem;
      }
      .account-actions {
        flex-direction: column;
        gap: 1rem;
      }
      .modal-content {
          padding: 20px;
      }
      .modal-content h2 {
          font-size: 1.8rem;
      }
      .modal-content p {
          font-size: 1rem;
      }
    }

    /* Password Change Section */
    .password-section {
      margin-top: 2.5rem;
      border-top: 1px solid var(--border-color);
      padding-top: 2rem;
      display: none;
    }
    .password-section h3 {
      font-family: 'Fredoka', sans-serif;
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      text-align: center;
      color: var(--text-light);
    }
    .password-section label {
      display: block;
      margin-bottom: 0.7rem;
      font-size: 1rem;
      color: var(--text-muted);
      font-weight: bold;
    }

    #change-password-btn {
      /* Inherits .btn-primary styles */
      display: block; /* Make it a block-level element */
      margin: 1.5rem auto 0 auto; /* Center it horizontally with auto margins, add top margin */
      width: fit-content; /* Ensure it only takes up the width of its content */
    }

    /* Edit/Save Icons */
    .edit-icon-btn, .save-icon-btn {
        background: none;
        border: none;
        color: var(--light-purple);
        font-size: 1.5rem; /* Larger icons */
        cursor: pointer;
        padding: 0;
        margin-left: auto;
        transition: var(--transition-ease);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* Prevent shrinking */
    }
    .edit-icon-btn:hover:not(:disabled), .save-icon-btn:hover:not(:disabled) {
        color: var(--primary-purple);
        transform: scale(1.1);
    }
    .edit-icon-btn:disabled, .save-icon-btn:disabled {
        color: #5e2b76;
        cursor: not-allowed;
        opacity: 0.6;
        transform: none;
    }

    /* Re-authentication Modal */
    .reauth-modal .modal-content {
      background-color: var(--dark-purple);
      color: var(--text-light);
    }
    .reauth-modal h2 {
      color: var(--text-light);
    }
    .reauth-modal label {
      color: var(--text-muted);
      font-weight: bold;
    }
    .reauth-modal .modal-actions {
      margin-top: 1.5rem;
    }

    /* Toast Notification */
    .toast-notification {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background-color: var(--success-green);
        color: var(--text-light);
        padding: 15px 25px;
        border-radius: var(--rounded-lg);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(50px);
        transition: opacity 0.4s ease-out, transform 0.4s ease-out, visibility 0.4s;
        font-family: 'IBM Plex Sans', sans-serif;
        font-size: 1rem;
        max-width: 350px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .toast-notification.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    .toast-notification.error {
        background-color: var(--error-red);
    }

    /* Email Verification Warning Bar */
    .email-verification-warning {
        background-color: var(--warning-yellow);
        color: #333;
        padding: 1.2rem;
        border-radius: var(--rounded-lg);
        margin-bottom: 2rem; /* More space below */
        text-align: center;
        font-weight: bold;
        display: none;
        flex-direction: column;
        gap: 15px; /* Increased gap */
        border: 1px solid rgba(0,0,0,0.1);
    }
    .email-verification-warning p {
        margin: 0;
        font-size: 1.05rem;
    }
    .email-verification-warning .btn-primary {
        background-color: #f0ad4e; /* Darker yellow for buttons */
        color: #333;
        border: 1px solid #e09b2e;
        flex: none;
        width: fit-content;
        margin: 0 auto;
        padding: 0.6rem 1.2rem; /* Adjusted padding */
        font-size: 0.95rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .email-verification-warning .btn-primary:hover {
        background-color: #e09b2e;
        transform: translateY(-1px);
    }

    /* New styles for Achievements Section */
    .achievements-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-color);
    }

    .achievements-section h3 {
        font-family: 'Fredoka', sans-serif;
        font-size: 2rem;
        margin-bottom: 1.5rem;
        text-align: center;
        color: var(--text-light);
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive grid */
        gap: 1.5rem; /* Space between achievement cards */
        padding: 1rem 0;
    }

    .achievement-item {
        background-color: var(--achievement-bg-locked);
        border: 1px solid var(--achievement-border-locked);
        border-radius: var(--rounded-lg);
        padding: 1rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 150px; /* Ensure consistent height */
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        cursor: pointer;
        opacity: 0.7; /* Default opacity for locked */
        filter: grayscale(80%); /* Grayscale for locked */
    }

    .achievement-item:hover {
        transform: translateY(-5px) scale(1.02); /* Lift and slightly enlarge on hover */
        box-shadow: 0 8px 25px rgba(0,0,0,0.6);
    }

    .achievement-item.unlocked {
        background: linear-gradient(145deg, var(--dark-purple) 0%, var(--primary-purple) 100%);
        border: 2px solid var(--achievement-border-unlocked);
        box-shadow: var(--achievement-glow); /* Glowing effect */
        opacity: 1;
        filter: grayscale(0%); /* Full color for unlocked */
    }

    .achievement-item.unlocked:hover {
        transform: translateY(-8px) scale(1.05); /* More pronounced lift for unlocked */
        box-shadow: var(--achievement-glow), 0 12px 30px rgba(126, 63, 242, 0.4); /* Enhanced glow on hover */
    }

    .achievement-icon {
        font-size: 3rem; /* Large icon */
        margin-bottom: 0.5rem;
        color: var(--achievement-icon-locked);
        transition: color 0.3s ease;
    }

    .achievement-item.unlocked .achievement-icon {
        color: var(--warning-yellow); /* Gold/yellow for unlocked icons */
        text-shadow: 0 0 5px rgba(255, 255, 0, 0.5); /* Subtle icon glow */
    }

    .achievement-title {
        font-family: 'Fredoka', sans-serif;
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--achievement-text-locked);
        margin-bottom: 0.3rem;
        transition: color 0.3s ease;
    }

    .achievement-item.unlocked .achievement-title {
        color: var(--achievement-text-unlocked);
    }

    .achievement-description {
        font-size: 0.9rem;
        color: var(--achievement-text-locked);
        line-height: 1.4;
        transition: color 0.3s ease;
    }

    .achievement-item.unlocked .achievement-description {
        color: var(--text-muted); /* Description can be slightly muted even when unlocked */
    }

    /* Responsive adjustments for achievements */
    @media (max-width: 480px) {
        #achievements-grid {
            grid-template-columns: 1fr; /* Single column on very small screens */
        }
        .achievement-item {
            min-height: 120px;
            padding: 0.8rem;
        }
        .achievements-section h3 {
            font-size: 1.8rem;
        }
        .achievement-icon {
            font-size: 2.5rem;
        }
        .achievement-title {
            font-size: 1.1rem;
        }
        .achievement-description {
            font-size: 0.85rem;
        }
    }

  </style>
</head>
<body class="account-container">
  <div class="account-card">
    <button class="back-button" onclick="window.location.href='home.html'">
      <span class="material-icons">arrow_back</span>
    </button>

    <div id="email-verification-warning" class="email-verification-warning">
      <p>Your email address is not verified. Please check your inbox (and spam folder) for a verification email.</p>
      <button class="btn-primary" id="resend-verification-email">Resend Verification Email</button>
      <button class="btn-primary" id="reload-email-status">I've Verified My Email</button>
    </div>

    <div class="avatar-container">
        <div class="account-avatar" id="account-initial-avatar">
        </div>
        <div class="level-indicator" id="level-indicator">
            <span id="level">0</span>
        </div>
    </div>

    <h2>Account Info</h2>

    <div class="account-details">
      <p>
        <strong>Username:</strong>
        <span id="account-username" contenteditable="false"></span>
        <button class="edit-icon-btn" id="edit-username-icon" title="Edit Username">
            <span class="material-icons">edit</span>
        </button>
        <button class="save-icon-btn" id="save-username-icon" title="Save Username" style="display:none;">
            <span class="material-icons">check</span>
        </button>
      </p>
      <p>
        <strong>Password:</strong> ********
        <button class="edit-icon-btn" id="change-password-icon" title="Change Password">
            <span class="material-icons">edit</span>
        </button>
      </p>
      <p><strong>Email:</strong> <span id="account-email"></span></p>
      <p><strong>UID:</strong> <span id="account-uid"></span></p>
      <p><strong>Joined:</strong> <span id="account-created"></span></p>
    </div>

    <div class="activity-summary">
      <p><strong>Total Quizzes Taken:</strong> <span id="total-quizzes">Loading...</span></p>
      <p><strong>Highest Score:</strong> <span id="high-score">Loading...</span></p>
      <p><strong>Total XP:</strong> <span id="total-xp">Loading...</span></p>
    </div>

    <!-- NEW Achievements Section -->
    <div class="achievements-section">
        <h3>Your Achievements</h3>
        <div id="achievements-grid">
            <!-- Achievements will be dynamically loaded here by JavaScript -->
        </div>
    </div>
    <!-- END NEW Achievements Section -->

    <div class="account-actions">
      <button class="btn-primary" id="delete-account">Delete Account</button>
      <button class="btn-primary" id="logout-btn">Log Out</button>
    </div>

    <div class="password-section" id="password-section">
      <h3>Change Password</h3>
      <label for="current-password">Current Password:</label>
      <input type="password" id="current-password" placeholder="Enter current password">

      <label for="new-password">New Password:</label>
      <input type="password" id="new-password" placeholder="Enter new password (min 6 chars)">

      <label for="confirm-new-password">Confirm New Password:</label>
      <input type="password" id="confirm-new-password" placeholder="Confirm new password">

      <button class="btn-primary" id="change-password-submit-btn">Update Password</button>
    </div>
  </div>

  <div id="logout-confirm-modal" class="modal">
    <div class="modal-content small-modal">
      <h2>Log Out?</h2>
      <p>Are you sure you want to log out?</p>
      <div class="modal-actions">
        <button id="logout-yes-btn" class="btn red-btn">Yes, Log Out</button>
        <button id="logout-no-btn" class="btn green-btn">No, Stay Logged In</button>
      </div>
    </div>
  </div>

  <div id="delete-confirm-modal" class="modal">
    <div class="modal-content small-modal">
      <h2>Delete Account?</h2>
      <p>Are you absolutely sure you want to delete your account? This action cannot be undone and all your data will be lost.</p>
      <div class="countdown-timer" id="delete-countdown"></div>
      <div class="modal-actions">
        <button id="delete-yes-btn" class="btn red-btn" disabled>Confirm Delete</button>
        <button id="delete-no-btn" class="btn green-btn">Cancel</button>
      </div>
    </div>
  </div>

  <div id="reauth-modal" class="modal reauth-modal">
    <div class="modal-content small-modal">
      <h2>Re-authenticate</h2>
      <p>For your security, please re-enter your password to proceed with this sensitive action.</p>
      <label for="reauth-email">Email:</label>
      <input type="email" id="reauth-email" disabled>
      <label for="reauth-password">Password:</label>
      <input type="password" id="reauth-password" placeholder="Enter your password">
      <div class="modal-actions">
        <button id="reauth-confirm-btn" class="btn green-btn">Confirm</button>
        <button id="reauth-cancel-btn" class="btn red-btn">Cancel</button>
      </div>
    </div>
  </div>

  <div id="toast-notification" class="toast-notification"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      updateProfile,
      deleteUser,
      updatePassword,
      EmailAuthProvider,
      reauthenticateWithCredential,
      sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZLZPVAlZUJWLturWzJ3nqyceZbSIevl4",
      authDomain: "mindblast-icons.firebaseapp.com",
      projectId: "mindblast-icons",
      storageBucket: "mindblast-icons.appspot.com",
      messagingSenderId: "807795058423",
      appId: "1:807795058423:web:2066a5d149852a43af55f2",
      measurementId: "G-LSJ3SWQP6M"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const usernameEl = document.getElementById('account-username');
    const emailEl = document.getElementById('account-email');
    const uidEl = document.getElementById('account-uid');
    const createdEl = document.getElementById('account-created');
    const quizzesEl = document.getElementById('total-quizzes');
    const highScoreEl = document.getElementById('high-score');
    const achievementsGridEl = document.getElementById('achievements-grid'); // Changed to grid container
    const accountAvatarEl = document.getElementById('account-initial-avatar');
    const totalXPEl = document.getElementById('total-xp');
    const levelEl = document.getElementById('level'); // Level span inside the indicator
    const levelIndicatorEl = document.getElementById('level-indicator'); // The level indicator div itself


    const logoutBtn = document.getElementById('logout-btn');
    const deleteAccountBtn = document.getElementById('delete-account');

    const logoutConfirmModal = document.getElementById('logout-confirm-modal');
    const logoutYesBtn = document.getElementById('logout-yes-btn');
    const logoutNoBtn = document.getElementById('logout-no-btn');

    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const deleteYesBtn = document.getElementById('delete-yes-btn'); // Corrected ID
    const deleteNoBtn = document.getElementById('delete-no-btn');
    const deleteCountdownEl = document.getElementById('delete-countdown');

    let countdownInterval;

    const passwordSection = document.getElementById('password-section');
    const currentPasswordInput = document.getElementById('current-password');
    const newPasswordInput = document.getElementById('new-password');
    const confirmNewPasswordInput = document.getElementById('confirm-new-password');
    const changePasswordSubmitBtn = document.getElementById('change-password-submit-btn'); // Corrected ID

    const editUsernameIcon = document.getElementById('edit-username-icon');
    const saveUsernameIcon = document.getElementById('save-username-icon');
    const changePasswordIcon = document.getElementById('change-password-icon');

    const reauthModal = document.getElementById('reauth-modal');
    const reauthEmailInput = document.getElementById('reauth-email');
    const reauthPasswordInput = document.getElementById('reauth-password');
    const reauthConfirmBtn = document.getElementById('reauth-confirm-btn');
    const reauthCancelBtn = document.getElementById('reauth-cancel-btn');

    const emailVerificationWarning = document.getElementById('email-verification-warning');
    const resendVerificationEmailBtn = document.getElementById('resend-verification-email');
    const reloadEmailStatusBtn = document.getElementById('reload-email-status');

    let sensitiveActionCallback = null;

    // Achievement Definitions (Copied from quiz.html for consistency)
    const ACHIEVEMENTS = [
        {
            id: "FIRST_QUIZ_COMPLETE",
            name: "First Steps!",
            description: "Complete your very first quiz.",
            icon: "emoji_events", // Material Icons name
            criteria: { quizzesCompleted: 1 }
        },
        {
            id: "EASY_MASTER",
            name: "Easy Peasy!",
            description: "Complete the Easy difficulty quiz.",
            icon: "star",
            criteria: { difficultyCompleted: "Easy" }
        },
        {
            id: "MEDIUM_MASTER",
            name: "Medium Mover!",
            description: "Complete the Medium difficulty quiz.",
            icon: "star_half",
            criteria: { difficultyCompleted: "Medium" }
        },
        {
            id: "HARD_MASTER",
            name: "Hard Hitter!",
            description: "Complete the Hard difficulty quiz.",
            icon: "star_border",
            criteria: { difficultyCompleted: "Hard" }
        },
        {
            id: "QUIZ_BEGINNER", // NEW ACHIEVEMENT
            name: "Quiz Beginner",
            description: "Complete 5 quizzes.",
            icon: "sentiment_very_satisfied", // Material Icons name
            criteria: { quizzesCompleted: 5 }
        },
        {
            id: "QUIZ_MASTER_10",
            name: "Quiz Enthusiast!",
            description: "Complete 10 quizzes.",
            icon: "quiz",
            criteria: { quizzesCompleted: 10 }
        },
        {
            id: "QUIZ_MASTER_50",
            name: "Quiz Veteran!",
            description: "Complete 50 quizzes.",
            icon: "school",
            criteria: { quizzesCompleted: 50 }
        },
        {
            id: "PERFECT_SCORE_1",
            name: "Flawless Start!",
            description: "Achieve 1 perfect score.",
            icon: "check_circle",
            criteria: { perfectScores: 1 }
        },
        {
            id: "PERFECT_SCORE_5",
            name: "Perfect Streak!",
            description: "Achieve 5 perfect scores.",
            icon: "military_tech",
            criteria: { perfectScores: 5 }
        },
        {
            id: "PERFECT_SCORE_10",
            name: "Unstoppable!",
            description: "Achieve 10 perfect scores.",
            icon: "workspace_premium",
            criteria: { perfectScores: 10 }
        },
        // Add more achievements here as needed, ensure icons are Material Icons
    ];


    const showToast = (message, type = 'success', duration = 3000) => {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.className = 'toast-notification';
        toast.classList.add('show');
        toast.classList.add(type);

        if (toast.timeoutId) {
            clearTimeout(toast.timeoutId);
        }

        toast.timeoutId = setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toast.classList.remove(type);
                toast.textContent = '';
                toast.timeoutId = null;
            }, 500);
        }, duration);
    };

    const getFirebaseErrorMessage = (error) => {
      switch (error.code) {
        case 'auth/email-already-in-use': return 'This email address is already registered.';
        case 'auth/invalid-email': return 'The email address is not valid.';
        case 'auth/operation-not-allowed': return 'Account type not enabled. Please contact support.';
        case 'auth/weak-password': return 'The password is too weak. Please choose a stronger one (at least 6 characters).';
        case 'auth/user-disabled': return 'This account has been disabled.';
        case 'auth/user-not-found':
        case 'auth/wrong-password': return 'Incorrect email or password.';
        case 'auth/requires-recent-login': return 'This action requires you to log in again for security.';
        case 'auth/too-many-requests': return 'Too many attempts. Please try again later.';
        case 'auth/network-request-failed': return 'Network error. Please check your internet connection.';
        default: return `An unexpected error occurred: ${error.message.replace('Firebase: ', '')}`;
      }
    };

    const updateUIForEmailVerification = (user) => {
      if (user && !user.emailVerified) {
          emailVerificationWarning.style.display = 'flex';
          editUsernameIcon.disabled = true;
          saveUsernameIcon.disabled = true;
          changePasswordIcon.disabled = true;
          deleteAccountBtn.disabled = true;
          changePasswordSubmitBtn.disabled = true; // Use the correct ID for the submit button
          usernameEl.contentEditable = false;
      } else {
          emailVerificationWarning.style.display = 'none';
          editUsernameIcon.disabled = false;
          changePasswordIcon.disabled = false;
          deleteAccountBtn.disabled = false;
          changePasswordSubmitBtn.disabled = false; // Use the correct ID for the submit button
      }
    };

    // Function to render achievements
    const renderAchievements = (userAchievementsData = {}) => {
        achievementsGridEl.innerHTML = ''; // Clear existing achievements

        ACHIEVEMENTS.forEach(achievement => {
            const isUnlocked = userAchievementsData[achievement.id]?.unlocked === true;

            const achievementItem = document.createElement('div');
            achievementItem.classList.add('achievement-item');
            if (isUnlocked) {
                achievementItem.classList.add('unlocked');
            } else {
                achievementItem.classList.add('locked');
            }
            achievementItem.setAttribute('data-achievement-id', achievement.id);

            achievementItem.innerHTML = `
                <span class="material-icons achievement-icon">${achievement.icon}</span>
                <div class="achievement-title">${achievement.name}</div>
                <div class="achievement-description">${achievement.description}</div>
            `;
            achievementsGridEl.appendChild(achievementItem);
        });
    };


    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Force a token refresh to ensure email_verified status is up-to-date in the token
        try {
            await user.reload(); // Reloads the user's profile data
            await user.getIdToken(true); // Forces a refresh of the ID token
            console.log("ID Token refreshed. Email verified status:", user.emailVerified);
        } catch (tokenRefreshError) {
            console.error("Error refreshing ID token:", tokenRefreshError);
            // Handle error, maybe show a message to log out/in
        }

        updateUIForEmailVerification(user);

        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          usernameEl.textContent = data.username || user.displayName || "Unknown";
          emailEl.textContent = user.email;
          uidEl.textContent = user.uid.substring(0, 18) + '...';
          createdEl.textContent = new Date(data.createdAt.seconds * 1000).toLocaleDateString();
          quizzesEl.textContent = data.totalQuizzes || 0;
          highScoreEl.textContent = data.highScore || 0;
          totalXPEl.textContent = data.totalXP || 0;
          levelEl.textContent = data.level || 0; // Set the level in the indicator

          const userInitial = (data.username || user.displayName ? (data.username || user.displayName)[0] : '?').toUpperCase();
          accountAvatarEl.textContent = userInitial;

          // Render achievements based on user data
          renderAchievements(data.achievements || {}); // Pass achievements data
        } else {
          const userInitial = (user.displayName ? user.displayName[0] : '?').toUpperCase();
          accountAvatarEl.textContent = userInitial;
          quizzesEl.textContent = 0;
          highScoreEl.textContent = 0;
          totalXPEl.textContent = 0;
          levelEl.textContent = 0;
          renderAchievements({}); // Render all locked for new users
        }

        reauthEmailInput.value = user.email;

      } else {
        window.location.href = 'auth.html';
      }
    });

    logoutBtn.addEventListener('click', () => {
      logoutConfirmModal.style.display = 'flex';
    });

    logoutYesBtn.addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'home.html';
      logoutConfirmModal.style.display = 'none';
    });

    logoutNoBtn.addEventListener('click', () => {
      logoutConfirmModal.style.display = 'none';
    });

    deleteAccountBtn.addEventListener('click', () => {
      if (!auth.currentUser || !auth.currentUser.emailVerified) {
          showToast("Please verify your email to delete your account.", "error");
          return;
      }
      deleteConfirmModal.style.display = 'flex';
      startDeleteCountdown(5); // Start the countdown
    });

    function startDeleteCountdown(seconds) {
      let timeLeft = seconds;
      deleteYesBtn.disabled = true; // Disable button initially
      deleteCountdownEl.textContent = `You can confirm in ${timeLeft} seconds.`;

      clearInterval(countdownInterval); // Clear any existing interval
      countdownInterval = setInterval(() => {
        timeLeft--;
        if (timeLeft > 0) {
          deleteCountdownEl.textContent = `You can confirm in ${timeLeft} seconds.`;
        } else {
          clearInterval(countdownInterval);
          deleteCountdownEl.textContent = "Click 'Confirm Delete' to proceed.";
          deleteYesBtn.disabled = false; // Enable button after countdown
        }
      }, 1000);
    }

    function resetDeleteModal() {
      clearInterval(countdownInterval);
      deleteYesBtn.disabled = true;
      deleteCountdownEl.textContent = '';
      deleteConfirmModal.style.display = 'none';
    }

    deleteYesBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (user) {
          sensitiveActionCallback = async () => {
              try {
                  const leaderboardDocRef = doc(db, "Leaderboard", user.uid);
                  // Use a transaction for atomic deletion if needed, but for simple docs, direct delete is fine
                  await deleteDoc(leaderboardDocRef).catch(error => {
                      if (error.code === 'not-found') {
                          console.log("Leaderboard entry not found, skipping deletion.");
                      } else {
                          throw error; // Re-throw if it's another error
                      }
                  });

                  const userDocRef = doc(db, "users", user.uid);
                  await deleteDoc(userDocRef).catch(error => {
                      if (error.code === 'not-found') {
                          console.log("User document not found, skipping deletion.");
                      } else {
                          throw error; // Re-throw if it's another error
                      }
                  });

                  await deleteUser(user);

                  showToast("Account and associated data deleted successfully.", "success");
                  setTimeout(() => {
                      window.location.href = 'home.html';
                  }, 2000);
              } catch (error) {
                  console.error("Error deleting account or associated data:", error);
                  showToast(getFirebaseErrorMessage(error), "error");
              } finally {
                  resetDeleteModal();
                  reauthModal.style.display = 'none';
              }
          };
          reauthModal.style.display = 'flex';
          reauthPasswordInput.focus();
          reauthPasswordInput.value = '';
      }
    });

    deleteNoBtn.addEventListener('click', () => {
      resetDeleteModal();
    });

    editUsernameIcon.addEventListener('click', () => {
      if (!auth.currentUser || !auth.currentUser.emailVerified) {
          showToast("Please verify your email to update your username.", "error");
          return;
      }
      usernameEl.contentEditable = true;
      usernameEl.focus();
      // Place cursor at the end
      setTimeout(() => {
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(usernameEl);
          range.collapse(false);
          selection.removeAllRanges();
          selection.addRange(range);
      }, 0);

      editUsernameIcon.style.display = 'none';
      saveUsernameIcon.style.display = 'flex';
    });

    saveUsernameIcon.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user || !user.emailVerified) {
          showToast("Please verify your email to update your username.", "error");
          usernameEl.contentEditable = false;
          editUsernameIcon.style.display = 'flex';
          saveUsernameIcon.style.display = 'none';
          return;
      }

      const newUsername = usernameEl.textContent.trim();
      if (newUsername.length < 3) {
        showToast("Username must be at least 3 characters.", "error");
        return;
      }

      // Check if username actually changed
      const currentUserDoc = await getDoc(doc(db, "users", user.uid));
      const currentDbUsername = currentUserDoc.exists() ? currentUserDoc.data().username : user.displayName;
      if (newUsername === currentDbUsername) {
          showToast("Username is already the same.", "success");
          usernameEl.contentEditable = false;
          editUsernameIcon.style.display = 'flex';
          saveUsernameIcon.style.display = 'none';
          return;
      }


      sensitiveActionCallback = async () => {
          try {
              const userRef = doc(db, "users", user.uid);
              const leaderboardRef = doc(db, "Leaderboard", user.uid);

              await updateProfile(user, { displayName: newUsername });
              await updateDoc(userRef, { username: newUsername });

              const leaderboardSnap = await getDoc(leaderboardRef);
              if (leaderboardSnap.exists()) {
                  await updateDoc(leaderboardRef, { name: newUsername });
              }

              showToast("Username updated!", "success");
              accountAvatarEl.textContent = newUsername[0].toUpperCase();

          } catch (error) {
              console.error("Failed to update username:", error);
              showToast(getFirebaseErrorMessage(error), "error");
          } finally {
              usernameEl.contentEditable = false;
              editUsernameIcon.style.display = 'flex';
              saveUsernameIcon.style.display = 'none';
              reauthModal.style.display = 'none';
          }
      };
      reauthModal.style.display = 'flex';
      reauthPasswordInput.focus();
      reauthPasswordInput.value = '';
    });

    changePasswordIcon.addEventListener('click', () => {
      if (!auth.currentUser || !auth.currentUser.emailVerified) {
          showToast("Please verify your email to change your password.", "error");
          return;
      }
      if (passwordSection.style.display === 'none' || passwordSection.style.display === '') {
        passwordSection.style.display = 'block';
        currentPasswordInput.focus();
      } else {
        passwordSection.style.display = 'none';
        currentPasswordInput.value = '';
        newPasswordInput.value = '';
        confirmNewPasswordInput.value = '';
      }
    });

    changePasswordSubmitBtn.addEventListener('click', async () => { // Changed to changePasswordSubmitBtn
      const user = auth.currentUser;
      if (!user || !user.emailVerified) {
        showToast("Please verify your email to update your password.", "error");
        return;
      }

      const currentPassword = currentPasswordInput.value;
      const newPassword = newPasswordInput.value;
      const confirmNewPassword = confirmNewPasswordInput.value;

      if (!currentPassword || !newPassword || !confirmNewPassword) {
        showToast("Please fill in all password fields.", "error");
        return;
      }

      if (newPassword.length < 6) {
        showToast("New password must be at least 6 characters long.", "error");
        return;
      }

      if (newPassword !== confirmNewPassword) {
        showToast("New password and confirm password do not match.", "error");
        return;
      }

      sensitiveActionCallback = async () => {
          try {
              // Re-authenticate with current password before updating
              const credential = EmailAuthProvider.credential(user.email, currentPassword);
              await reauthenticateWithCredential(user, credential);
              
              await updatePassword(user, newPassword);
              showToast("Password updated successfully!", "success");
              currentPasswordInput.value = '';
              newPasswordInput.value = '';
              confirmNewPasswordInput.value = '';
              passwordSection.style.display = 'none';
          } catch (error) {
              console.error("Error updating password:", error);
              // Specific error for wrong current password
              if (error.code === 'auth/wrong-password') {
                  showToast("Incorrect current password.", "error");
              } else {
                  showToast(getFirebaseErrorMessage(error), "error");
              }
          } finally {
              reauthModal.style.display = 'none'; // Close reauth modal
              reauthPasswordInput.value = ''; // Clear reauth password
          }
      };
      // Trigger re-authentication modal if needed (Firebase will handle if it's recent login)
      // For password change, Firebase often requires recent login, so directly call the callback
      // after re-authentication.
      reauthModal.style.display = 'flex';
      reauthPasswordInput.focus();
      reauthPasswordInput.value = '';
    });

    reauthConfirmBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      const email = reauthEmailInput.value;
      const password = reauthPasswordInput.value;

      if (!email || !password) {
        showToast("Please enter both email and password.", "error");
        return;
      }

      try {
        const credential = EmailAuthProvider.credential(email, password);
        await reauthenticateWithCredential(user, credential);
        reauthModal.style.display = 'none';
        reauthPasswordInput.value = '';
        if (sensitiveActionCallback) {
          sensitiveActionCallback();
          sensitiveActionCallback = null;
        }
      } catch (error) {
        console.error("Re-authentication failed:", error);
        showToast(getFirebaseErrorMessage(error), "error");
      }
    });

    reauthCancelBtn.addEventListener('click', () => {
      reauthModal.style.display = 'none';
      reauthPasswordInput.value = '';
      sensitiveActionCallback = null;
      resetDeleteModal();
      usernameEl.contentEditable = false;
      editUsernameIcon.style.display = 'flex';
      saveUsernameIcon.style.display = 'none';
      passwordSection.style.display = 'none';
      currentPasswordInput.value = '';
      newPasswordInput.value = '';
      confirmNewPasswordInput.value = '';
    });

    resendVerificationEmailBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (user) {
        try {
          await sendEmailVerification(user);
          showToast("Verification email sent! Check your inbox (and spam).", "success");
        } catch (error) {
          console.error("Error resending verification email:", error);
          showToast(getFirebaseErrorMessage(error), "error");
        }
      }
    });

    reloadEmailStatusBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (user) {
        try {
          await user.reload();
          updateUIForEmailVerification(user);
          if (user.emailVerified) {
            showToast("Email successfully verified!", "success");
          } else {
            showToast("Email still not verified. Please check your email or try again.", "error");
          }
        } catch (error) {
          console.error("Error reloading user status:", error);
          showToast(getFirebaseErrorMessage(error), "error");
        }
      }
    });

    window.addEventListener('click', (event) => {
      if (event.target === logoutConfirmModal) {
        logoutConfirmModal.style.display = 'none';
      }
      if (event.target === deleteConfirmModal) {
        resetDeleteModal();
      }
      if (event.target === reauthModal) {
          reauthModal.style.display = 'none';
          reauthPasswordInput.value = '';
          sensitiveActionCallback = null;
          resetDeleteModal();
          usernameEl.contentEditable = false;
          editUsernameIcon.style.display = 'flex';
          saveUsernameIcon.style.display = 'none';
          passwordSection.style.display = 'none';
          currentPasswordInput.value = '';
          newPasswordInput.value = '';
          confirmNewPasswordInput.value = '';
      }
    });
  </script>
</body>
</html>
