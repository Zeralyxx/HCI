<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <title>MindBlast | Quiz</title>
  <style>
    :root {
      --bg-light: #f0f2f5;
      --white: #ffffff;
      --gray: #e0e0e0;
      --green: #d2f6d2;
      --red: #f8d2d2;
      --rounded: 20px;
      --shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      --primary-font: 'Segoe UI', sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--primary-font);
      margin: 0;
      background: linear-gradient(135deg, #2E0B40, #3E1A58, #4E2A70);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 16px;
    }

    #start-screen, #quiz-screen {
      background: var(--white);
      padding: 24px;
      border-radius: var(--rounded);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 420px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
    }

    #quiz-screen {
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    h1, h2 {
      margin-bottom: 16px;
    }

    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: var(--rounded);
      font-size: 16px;
      cursor: pointer;
      background-color: var(--gray);
      transition: background 0.3s ease;
    }

    .btn span {
      font-size: 20px;
      vertical-align: middle;
      margin-right: 8px;
    }

    .btn:hover {
      background-color: #d0d0d0;
    }

    .option {
      background: var(--gray);
      transition: background 0.3s ease;
    }

    .correct {
      background-color: var(--green) !important;
    }

    .incorrect {
      background-color: var(--red) !important;
    }

    #icon-placeholder {
      font-size: 60px;
      background: #ccc;
      border-radius: var(--rounded);
      padding: 20px;
      width: 100px;
      height: 100px;
      color: #333;
      margin: 0 auto;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #progress {
      font-weight: bold;
      margin-top: 12px;
    }

    #timer {
      position: absolute;
      top: 16px;
      right: 24px;
      font-weight: bold;
      color: #333;
    }

    .close {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 999;
      color: white;
      text-decoration: none;
      font-size: 28px;
      padding: 4px;
      border-radius: 50%;
      transition: background 0.3s ease;
    }

    .close:hover {
      background-color: rgba(0, 0, 0, 0.4);
    }

  /* Certificate Modal Styles */
  .modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgba(0, 0, 0, 0.7); /* Black w/ opacity */
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border-radius: var(--rounded);
    box-shadow: var(--shadow);
    width: 80%;
    max-width: 600px; /* Adjust max-width as needed */
    text-align: center;
    position: relative;
    animation: fadeIn 0.3s ease-out;
  }

  .close-modal-btn {
    color: #aaa;
    position: absolute;
    top: 10px;
    left: 20px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close-modal-btn:hover,
  .close-modal-btn:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }

  .certificate-preview {
    max-width: 100%;
    height: auto;
    margin: 20px 0;
    border: 1px solid #ddd;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  #download-certificate-btn {
    background-color: #4CAF50; /* Green download button */
    color: white;
  }

  #download-certificate-btn:hover {
    background-color: #45a049;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }


    @media (max-width: 480px) {
      #start-screen, #quiz-screen {
        padding: 16px;
      }

      .btn {
        font-size: 14px;
        padding: 10px;
      }

      #timer {
        top: 12px;
        right: 16px;
        font-size: 14px;
      }
    }
    .progress-container {
      width: 100%;
      background-color: var(--gray);
      border-radius: var(--rounded);
      overflow: hidden;
      height: 16px;
      margin: 8px 0;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .progress-bar {
      height: 100%;
      background-color: #4caf50;
      width: 0%;
      transition: width 0.3s ease;

    #score-display {
      position: absolute;
      top: 16px;
      right: 100px;
      text-align: right;
      font-weight: bold;
      color: white;
      z-index: 10;
    }
    
    #score-feedback {
      color: #00ff88;
      font-size: 18px;
      opacity: 0;
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    
    #score-feedback.show {
      opacity: 1;
      transform: translateY(-10px);
    }

    }
  </style>
</head>
<body>

  <a href="home.html" class="close" aria-label="Close">
  <span class="material-symbols-outlined">close</span>
</a>
<!-- Background Music -->
<audio id="bg-music" loop autoplay>
  <source src="music/background.mp3" type="audio/mp3" />
  Your browser does not support the audio element.
</audio>

<!-- Correct Answer Sound -->
<audio id="correct-sound">
  <source src="sounds/correct.mp3" type="audio/mp3" />
</audio>

<!-- Incorrect Answer Sound -->
<audio id="incorrect-sound">
  <source src="sounds/incorrect.mp3" type="audio/mp3" />
</audio>


  <div id="start-screen">
    <h1>Start Quiz</h1>
    <p>Select difficulty:</p>
    <button class="btn" id="easy-btn-icon">üü¢ Easy</button>
    <button class="btn" id="medium-btn-icon">üü° Medium</button>
    <button class="btn" id="hard-btn-icon">üî¥ Hard</button>
    <button class="btn" id="claim-btn-icon">Claim Certificate</button>
  </div>

  <div id="quiz-screen">
    <div id="timer">‚è±Ô∏è 60s</div>
    <div id="score-display">
      <div id="total-score">Score: 0</div>
      <div id="score-feedback"></div>
    </div>
    <h2>What is this icon?</h2>
    <div id="icon-placeholder">üî≤</div>
    <div id="options"></div>
    <div id="progress">1/10</div>
    <div class="progress-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>

 <div id="certificate-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal-btn">&times;</span>
      <h2>üéâ Congratulations! üéâ</h2>
      <p>You've mastered the icons! Here's your certificate:</p>
      <canvas id="certificate-canvas" style="border: 1px solid #ddd; max-width: 100%; height: auto; display: block; margin: 20px auto;"></canvas>
      <button id="download-certificate-btn" class="btn">Download Certificate</button>
    </div>
  </div>

  <script type="module">
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

  import {
    getFirestore,
    collection,
    getDocs,
    addDoc,
    serverTimestamp,
    query,
    where,
    updateDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
  import {
    getAnalytics
  } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAZLZPVAlZUJWLturWzJ3nqyceZbSIevl4",
    authDomain: "mindblast-icons.firebaseapp.com",
    projectId: "mindblast-icons",
    storageBucket: "mindblast-icons.firebasestorage.app",
    messagingSenderId: "807795058423",
    appId: "1:807795058423:web:2066a5d149852a43af55f2",
    measurementId: "G-LSJ3SWQP6M"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const analytics = getAnalytics(app);

  let quizData = [];
  let currentQuestion = 0;
  let score = 0;
  let correctAnswers = 0;
  let difficulty = '';
  let questionStartTime = 0;
  let currentUser = null;
  let timePerQuestion = 20;
  let currentTimer = 0;
  let timerInterval;

  
  const totalScoreDisplay = document.getElementById("total-score");
  const scoreFeedback = document.getElementById("score-feedback");
  const startScreen = document.getElementById("start-screen");
  const quizScreen = document.getElementById("quiz-screen");
  const iconPlaceholder = document.getElementById("icon-placeholder");
  const optionsDiv = document.getElementById("options");
  const progressText = document.getElementById("progress");
  const timerDisplay = document.getElementById("timer");
  // Add these lines near your other document.getElementById calls
  const claimCertificateBtn = document.getElementById("claim-btn-icon");
  const certificateModal = document.getElementById("certificate-modal");
  const closeModalBtn = document.querySelector(".close-modal-btn");
  const downloadCertificateBtn = document.getElementById("download-certificate-btn");
  const certificateCanvas = document.getElementById('certificate-canvas'); // Get the canvas element
  const ctx = certificateCanvas.getContext('2d');
  const bgMusic = document.getElementById("bg-music");
  const correctSound = document.getElementById("correct-sound");
  const incorrectSound = document.getElementById("incorrect-sound");
  
  // Optional: Allow user interaction to resume music if browser blocks autoplay
  document.body.addEventListener("click", () => {
    if (bgMusic.paused) {
      bgMusic.play().catch(() => {});
    }
  });

  // Check login state
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
    } else {
      alert("You must be logged in to play the quiz.");
      window.location.href = "auth.html"; // redirect to login
    }
  });

  async function startQuiz(diff) {
    if (!currentUser) return;
    difficulty = diff;
    if (difficulty === "Easy") timePerQuestion = 20;
    else if (difficulty === "Medium") timePerQuestion = 15;
    else if (difficulty === "Hard") timePerQuestion = 10;

    quizData = await loadQuestions(diff);
    currentQuestion = 0;
    score = 0;
    correctAnswers = 0;
    startScreen.style.display = "none";
    quizScreen.style.display = "flex";
    startTimer();
    document.getElementById("progress-bar").style.width = `0%`;
    showQuestion();
  }

  async function loadQuestions(difficulty) {
    const colRef = collection(db, difficulty.charAt(0).toUpperCase() + difficulty.slice(1));
    const snapshot = await getDocs(colRef);
    let questions = [];

    snapshot.forEach(doc => {
      const data = doc.data();
      questions.push({
        icon: `<span class="material-symbols-outlined">${data.icon}</span>`,
        options: shuffleArray([...data.options]),
        answer: data.answer
      });
    });

    return shuffleArray(questions).slice(0, 10);
  }

  function shuffleArray(array) {
    return array.sort(() => Math.random() - 0.5);
  }

  function startTimer() {
    currentTimer = timePerQuestion;
    timerDisplay.textContent = `‚è±Ô∏è ${currentTimer}s`;

    clearInterval(timerInterval); // Clear previous timer if any

    timerInterval = setInterval(() => {
      currentTimer--;
      timerDisplay.textContent = `‚è±Ô∏è ${currentTimer}s`;
      if (currentTimer <= 0) {
        clearInterval(timerInterval);
        handleTimeUp();
      }
    }, 1000);
  }


  function showQuestion() {
    const q = quizData[currentQuestion];
    iconPlaceholder.innerHTML = q.icon;
    optionsDiv.innerHTML = "";
    progressText.textContent = `${currentQuestion + 1}/10`;
    document.getElementById("progress-bar").style.width = `${((currentQuestion + 1) / quizData.length) * 100}%`;
    questionStartTime = Date.now();

    q.options.forEach(option => {
      const btn = document.createElement("button");
      btn.classList.add("btn", "option");
      btn.textContent = option;
      btn.onclick = () => checkAnswer(btn, q.answer);
      optionsDiv.appendChild(btn);

    startTimer();

    });
  }

  function checkAnswer(selectedBtn, correctAnswer) {
    const timeTaken = (Date.now() - questionStartTime) / 1000;

    const buttons = document.querySelectorAll(".option");
    buttons.forEach(btn => {
      btn.disabled = true;
      if (btn.textContent === correctAnswer) {
        btn.classList.add("correct");
      } else {
        btn.classList.add("incorrect");
      }
    });

    if (selectedBtn.textContent === correctAnswer) {
      correctAnswers++;
      correctSound.play(); // ‚úÖ play correct sound
      let multiplier = 0;

      if (difficulty === "Easy") {
        multiplier = timeTaken <= 5 ? 2.0 : timeTaken <= 15 ? 1.0 : 0.5;
      } else if (difficulty === "Medium") {
        multiplier = timeTaken <= 5 ? 3.0 : timeTaken <= 10 ? 2.0 : 1.0;
      } else if (difficulty === "Hard") {
        multiplier = timeTaken <= 3 ? 4.0 : timeTaken <= 7 ? 3.0 : 1.5;
      }

      if (multiplier > 0) {
        const pointsEarned = Math.round(10 * multiplier);
        score += pointsEarned;
        updateScoreUI(pointsEarned);
      }
      updateScoreUI(0);
    }
    else {
      incorrectSound.play(); // ‚úÖ play incorrect sound
    }

    setTimeout(() => {
      currentQuestion++;
      if (currentQuestion < quizData.length) {
        showQuestion();
      } else {
        clearInterval(timerInterval);
        showScore();
      }
    }, 1000);
  }

  async function showScore() {
    setTimeout(async () => {
      const displayName = currentUser.displayName || currentUser.email;

      await uploadToLeaderboard(displayName, score, correctAnswers, difficulty);
      alert(`üéâ Quiz Complete!\nScore: ${score}\nCorrect Answers: ${correctAnswers}\n‚úÖ Score uploaded!`);

      if (confirm("Try again?")) {
        location.reload();
      } else {
        startScreen.style.display = "block";
        quizScreen.style.display = "none";
      }
    }, 200);
  }

  async function uploadToLeaderboard(name, score, correct, difficulty) {
  const user = auth.currentUser;
  if (!user) {
    console.error("User not authenticated.");
    return;
  }

  const leaderboardRef = doc(db, "Leaderboard", user.uid);
  const userRef = doc(db, "users", user.uid); // This was missing the doc import, as per previous advice

  const docSnap = await getDoc(leaderboardRef);

  if (docSnap.exists()) {
    const data = docSnap.data();
    await updateDoc(leaderboardRef, {
      score: (data.score || 0) + score,
      correct: (data.correct || 0) + correct,
      quizzesCompleted: (data.quizzesCompleted || 0) + 1,
      lastPlayed: serverTimestamp() // Consider if you want this for all updates or only initial
    });
  } else {
    // This is the crucial part for a new user's first quiz
    await setDoc(leaderboardRef, {
      name: user.displayName || name || "Anonymous",
      score: score, // This will be the score from their first quiz
      correct: correct, // This will be the correct answers from their first quiz
      difficulty: difficulty, // Store difficulty of their first quiz, or remove if not needed for leaderboard display
      quizzesCompleted: 1, // Set to 1 for their first completed quiz
      timestamp: serverTimestamp() // Use timestamp for initial entry
    });
  }

  // ‚úÖ Update activity summary in users collection (this part is good)
  const userSnap = await getDoc(userRef);
  const userData = userSnap.exists() ? userSnap.data() : {};

  if (userSnap.exists()) {
      await updateDoc(userRef, {
        totalQuizzes: (userData.totalQuizzes || 0) + 1,
        highScore: Math.max(score, userData.highScore || 0)
      });
    } else {
      // This 'else' block for userRef should ideally not be hit if user is authenticated
      // and their data was created on signup. But good to have as a fallback.
      await setDoc(userRef, {
        totalQuizzes: 1,
        highScore: score
      });
    }
  }

  function handleTimeUp() {
    const q = quizData[currentQuestion];
    
    const buttons = document.querySelectorAll(".option");
    buttons.forEach(btn => {
      btn.disabled = true;
      if (btn.textContent === q.answer) {
        btn.classList.add("correct");
      } else {
        btn.classList.add("incorrect");
      }
    });
  
    setTimeout(() => {
      currentQuestion++;
      if (currentQuestion < quizData.length) {
        showQuestion();
      } else {
        clearInterval(timerInterval);
        showScore();
      }
    }, 1000);
  }

  function updateScoreUI(points) {
    totalScoreDisplay.textContent = `Score: ${score}`;
    if (points > 0) {
      scoreFeedback.textContent = `+${points}`;
      scoreFeedback.classList.add("show");
    
      setTimeout(() => {
        scoreFeedback.classList.remove("show");
        scoreFeedback.textContent = "";
      }, 800);
    }
  }
  bgMusic.volume = 0.1;
  correctSound.volume = 1.0;
  incorrectSound.volume = 1.0;




  window.onload = () => {
    document.getElementById("easy-btn-icon").addEventListener("click", () => startQuiz("Easy"));
    document.getElementById("medium-btn-icon").addEventListener("click", () => startQuiz("Medium"));
    document.getElementById("hard-btn-icon").addEventListener("click", () => startQuiz("Hard"));
   // Certificate functionality
    claimCertificateBtn.addEventListener("click", async () => {
        if (!currentUser) {
            alert("Please log in to claim your certificate.");
            return;
        }

        // Optional: Add logic here to check if the user has completed all levels
        // For example, fetch user's data from Firestore and check 'totalQuizzes' or 'achievements'
        // if (user.totalQuizzes < requiredQuizzesForCertificate) {
        //     alert("Complete more quizzes to earn your certificate!");
        //     return;
        // }

        const userName = currentUser.displayName || "Valued User"; // Get user's name
        const today = new Date();
        const completionDate = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

        // Load the certificate template image
        const certificateImage = new Image();
        certificateImage.src = '/images/certificate-template.png'; // Make sure this path is correct

        certificateImage.onload = () => {
            // Set canvas dimensions to match the image
            certificateCanvas.width = certificateImage.width;
            certificateCanvas.height = certificateImage.height;

            // Draw the background image
            ctx.drawImage(certificateImage, 0, 0);

            // Set text styles for the name
            ctx.font = 'bold 100px Fredoka'; // Adjust font size and family as needed
            ctx.fillStyle = '#2E0B40'; // Adjust color to match your design (dark purple from your CSS)
            ctx.textAlign = 'center';

            // Draw the user's name on the underline
            // You'll need to adjust these coordinates (x, y) based on your image's layout
            // x: horizontal center of the canvas
            // y: estimated vertical position of the underline
            const nameX = certificateCanvas.width / 2;
            const nameY = certificateCanvas.height * 0.49; // Adjust this '0.53' multiplier as needed

            ctx.fillText(userName.toUpperCase(), nameX, nameY); // Convert name to uppercase if preferred

            // Set text styles for the date
            ctx.font = '30px IBM Plex Sans'; // Adjust font size and family
            ctx.fillStyle = '#2E0B40'; // Same color as name
            ctx.textAlign = 'center';

            // Draw the date below MindBlast
            // x: horizontal center of the canvas
            // y: estimated vertical position below MindBlast
            const dateX = certificateCanvas.width / 2;
            const dateY = certificateCanvas.height * 0.9; // Adjust this '0.86' multiplier as needed

            ctx.fillText(completionDate, dateX, dateY);

            // Show the modal
            certificateModal.style.display = "flex";

            // Set the download link for the generated certificate
            downloadCertificateBtn.onclick = () => {
                const dataURL = certificateCanvas.toDataURL('image/png'); // Get image data as PNG
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = `${userName}_MindBlast_Certificate.png`; // Dynamic download filename
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        };

        certificateImage.onerror = () => {
            console.error("Failed to load certificate template image.");
            alert("Could not load certificate template. Please try again later.");
        };
    });

    closeModalBtn.addEventListener("click", () => {
        certificateModal.style.display = "none";
    });

    // Close modal if user clicks outside of it
    window.addEventListener("click", (event) => {
        if (event.target == certificateModal) {
            certificateModal.style.display = "none";
        }
    });
  };
</script>

</body>
</html>
